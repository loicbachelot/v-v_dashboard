name: deploy-dev

on:
  # Allows manual execution from the Actions UI with optional inputs.
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to build/push (optional; defaults to commit SHA)"
        required: false
      stack:
        description: "Stack to deploy (DashboardStack or DashboardStackTest)"
        required: false
        default: DashboardStack
  push:
    branches: [ci/test]

permissions:
  contents: read

# Ensures only one deployment runs at a time for this workflow.
concurrency:
  group: deploy-dev
  cancel-in-progress: true

env:
  DEPLOY_REGION: us-west-2
  STACK_NAME: DashboardStack

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC authentication to AWS.

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install CDK deps
        run: |
          python -m pip install --upgrade pip
          pip install -r cdk/requirements.txt

      - name: Debug region
        run: |
          echo "GITHUB_REF=$GITHUB_REF"
          echo "DEPLOY_REGION=$DEPLOY_REGION"
          aws --version

      # Authenticates to AWS via OIDC, exchanging a GitHub token for temporary credentials.
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::818214664804:role/GitHubActionsDeployRole
          aws-region: ${{ env.DEPLOY_REGION }}
          role-session-name: gha-deploy

      - name: Get AWS account id
        id: aws
        run: echo "id=$(aws sts get-caller-identity --query Account --output text)" >> "$GITHUB_OUTPUT"

      # Idempotent step to create ECR repositories if they do not already exist.
      - name: Ensure ECR repos exist (idempotent)
        run: |
          aws ecr describe-repositories --region "$DEPLOY_REGION" --repository-names v-v_dashboard >/dev/null 2>&1 \
            || aws ecr create-repository --region "$DEPLOY_REGION" --repository-name v-v_dashboard
          aws ecr describe-repositories --region "$DEPLOY_REGION" --repository-names vv-lambda-upload >/dev/null 2>&1 \
            || aws ecr create-repository --region "$DEPLOY_REGION" --repository-name vv-lambda-upload

      - name: ECR login
        run: |
          aws ecr get-login-password --region "$DEPLOY_REGION" \
          | docker login --username AWS --password-stdin ${{ steps.aws.outputs.id }}.dkr.ecr.${{ env.DEPLOY_REGION }}.amazonaws.com

      - uses: docker/setup-buildx-action@v3

      - name: Build & push app image
        env:
          TAG: ${{ inputs.tag || github.sha }}
          REG: ${{ steps.aws.outputs.id }}.dkr.ecr.${{ env.DEPLOY_REGION }}.amazonaws.com
        run: |
          docker build -t v-v_dashboard:"$TAG" .
          docker tag  v-v_dashboard:"$TAG" "$REG"/v-v_dashboard:"$TAG"
          docker push "$REG"/v-v_dashboard:"$TAG"

      - name: Build & push lambda image (Docker v2 manifest)
        env:
          TAG: ${{ inputs.tag || github.sha }}
          REG: ${{ steps.aws.outputs.id }}.dkr.ecr.${{ env.DEPLOY_REGION }}.amazonaws.com
          DOCKER_BUILDKIT: 0 # Disable BuildKit to produce a Docker v2 manifest required by Lambda.
        run: |
          docker build -t vv-lambda-upload:"$TAG" -f lambda_process_uploads/Dockerfile lambda_process_uploads
          docker tag  vv-lambda-upload:"$TAG" "$REG"/vv-lambda-upload:"$TAG"
          docker push "$REG"/vv-lambda-upload:"$TAG"

      # Ensures the CDK bootstrap stack exists; fails gracefully if already bootstrapped.
      - name: CDK bootstrap (idempotent)
        run: |
          npx cdk@2 bootstrap aws://$(aws sts get-caller-identity --query Account --output text)/${DEPLOY_REGION} || true

      - name: CDK deploy (dev)
        run: |
          # Use the 'stack' input if provided, otherwise fall back to the default STACK_NAME.
          STACK="${{ inputs.stack || env.STACK_NAME }}"
          echo "Deploying stack: $STACK"
          npx cdk@2 deploy "$STACK" \
            -c appTag=${{ inputs.tag || github.sha }} \
            -c lambdaTag=${{ inputs.tag || github.sha }} \
            --require-approval never

      # Verifies that the primary service endpoints are responsive after deployment.
      - name: Smoke test
        env:
          STACK: ${{ inputs.stack || env.STACK_NAME }}
          REGION: ${{ env.DEPLOY_REGION }}
        run: |
          set -euo pipefail
          ALB_URL=$(aws cloudformation describe-stacks --stack-name "$STACK" --region "$REGION" \
            --query "Stacks[0].Outputs[?OutputKey=='ServiceURL'].OutputValue" --output text)
          API_HEALTH_URL=$(aws cloudformation describe-stacks --stack-name "$STACK" --region "$REGION" \
            --query "Stacks[0].Outputs[?OutputKey=='StatusAPIHealthURL'].OutputValue" --output text)
          echo "ALB:  $ALB_URL"
          echo "API:  $API_HEALTH_URL"
          echo "Checking ALB..."
          curl -fsS --max-time 20 "$ALB_URL" >/dev/null
          echo "Checking API health..."
          curl -fsS --max-time 20 "$API_HEALTH_URL" >/dev/null
          echo "Smoke test passed."